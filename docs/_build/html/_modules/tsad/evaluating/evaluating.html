

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>tsad.evaluating.evaluating &mdash; Time Series Anomaly Detection 0.15 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/project-template.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/project-template.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Time Series Anomaly Detection
          

          
          </a>

          
            
            
              <div class="version">
                0.15
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Description</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Time Series Anomaly detection.</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Evaluating.html">Evaluation of AD algorithms perfomance</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tsad.html">Subpackages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tsad.html#submodules">Submodules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tsad.html#module-tsad.feature_importance">tsad.feature_importance module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tsad.html#module-tsad.generate_residuals">tsad.generate_residuals module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tsad.html#module-tsad.main">tsad.main module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tsad.html#module-tsad.models">tsad.models module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tsad.html#module-tsad.src">tsad.src module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tsad.html#module-tsad.stastics">tsad.stastics module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tsad.html#module-tsad">Module contents</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Time Series Anomaly Detection</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>tsad.evaluating.evaluating</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tsad.evaluating.evaluating</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">CDSDSDS</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="k">as</span> <span class="nn">gridspec</span>



<span class="kn">from</span> <span class="nn">.univariate_funcs</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">single_average_delay</span><span class="p">,</span> <span class="n">single_evaluate_nab</span>
<span class="kn">from</span> <span class="nn">.src</span> <span class="kn">import</span> <span class="n">single_detecting_boundaries</span><span class="p">,</span> <span class="n">check_errors</span><span class="p">,</span> <span class="n">extract_cp_confusion_matrix</span>


<div class="viewcode-block" id="evaluating"><a class="viewcode-back" href="../../../tsad.evaluating.html#tsad.evaluating.evaluating.evaluating">[docs]</a><span class="k">def</span> <span class="nf">evaluating</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span>
               <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;nab&#39;</span><span class="p">,</span>
               <span class="n">numenta_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">portion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">anomaly_window_destenation</span><span class="o">=</span><span class="s1">&#39;lefter&#39;</span><span class="p">,</span>
               <span class="n">clear_anomalies_mode</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
               <span class="n">intersection_mode</span><span class="o">=</span><span class="s1">&#39;cut right window&#39;</span><span class="p">,</span>
               <span class="n">table_of_coef</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">scale_func</span> <span class="o">=</span> <span class="s2">&quot;improved&quot;</span><span class="p">,</span>
               <span class="n">scale_koef</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>               
               <span class="n">plot_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
               <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    true: variants:</span>
<span class="sd">        or: if one  dataset : pd.Series with binary int labels (1 is </span>
<span class="sd">        anomaly, 0 is not anomaly);</span>
<span class="sd">        or: if one  dataset : list of pd.Timestamp of true labels, or [] </span>
<span class="sd">        if haven&#39;t labels </span>
<span class="sd">        or: if one  dataset : list of list of t1,t2: left and right </span>
<span class="sd">        detection, boundaries of pd.Timestamp or [[]] if haven&#39;t labels</span>
<span class="sd">        </span>
<span class="sd">        or: if many datasets: list (len of number of datasets) of pd.Series </span>
<span class="sd">        with binary int labels;</span>
<span class="sd">        or: if many datasets: list of list of pd.Timestamp of true labels, or</span>
<span class="sd">        true = [ts,[]] if haven&#39;t labels for specific dataset</span>
<span class="sd">        or: if many datasets: list of list of list of t1,t2: left and right </span>
<span class="sd">        detection boundaries of pd.Timestamp;</span>
<span class="sd">        If we haven&#39;t true labels for specific dataset then we must insert </span>
<span class="sd">        empty list of labels: true = [[[]],[[t1,t2],[t1,t2]]]. </span>
<span class="sd">        </span>
<span class="sd">        __True labels of anomalies or changepoints.</span>
<span class="sd">        It is important to have appropriate labels (CP or </span>
<span class="sd">        anomaly) for corresponding metric (See later &quot;metric&quot;)</span>
<span class="sd">        </span>
<span class="sd">    prediction: variants:</span>
<span class="sd">        or: if one  dataset : pd.Series with binary int labels</span>
<span class="sd">        (1 is anomaly, 0 is not anomaly);</span>
<span class="sd">        or: if many datasets: list (len of number of datasets) </span>
<span class="sd">        of pd.Series with binary int labels.</span>
<span class="sd">        </span>
<span class="sd">        __Predicted labels of anomalies or changepoints.</span>
<span class="sd">        It is important to have appropriate labels (CP or </span>
<span class="sd">        anomaly) for corresponding metric (See later &quot;metric&quot;)</span>
<span class="sd">        </span>
<span class="sd">    metric: {&#39;nab&#39;, &#39;binary&#39;, &#39;average_time&#39;, &#39;confusion_matrix&#39;}. </span>
<span class="sd">        Default=&#39;nab&#39;</span>
<span class="sd">        Affects to output (see later: Returns)</span>
<span class="sd">        Changepoint problem: {&#39;nab&#39;, &#39;average_time&#39;}. </span>
<span class="sd">        Standart AD problem: {&#39;binary&#39;, &#39;confusion_matrix&#39;}. </span>
<span class="sd">        &#39;nab&#39; is Numenta Anomaly Benchmark metric</span>
<span class="sd">        &#39;average_time&#39; is both average delay or time to failure</span>
<span class="sd">        depend on situatuion.</span>
<span class="sd">        &#39;binary&#39;: FAR, MAR, F1.</span>
<span class="sd">        &#39;confusion_matrix&#39; standart confusion_matrix for any point.</span>
<span class="sd">        </span>
<span class="sd">    numenta_time: &#39;str&#39; for pd.Tiemdelta</span>
<span class="sd">        Width of detection window. Default=None.</span>
<span class="sd">        </span>
<span class="sd">    portion : float, default=0.1</span>
<span class="sd">        The portion is needed if numenta_time = None. </span>
<span class="sd">        The width of the detection window in this case is equal </span>
<span class="sd">        to a portion of the width of the length of prediction divided </span>
<span class="sd">        by the number of real CPs in this dataset. Default=0.1.</span>
<span class="sd">        </span>
<span class="sd">    anomaly_window_destenation: {&#39;lefter&#39;, &#39;righter&#39;, &#39;center&#39;}. Defualt=&#39;right&#39;</span>
<span class="sd">        The parameter of the location of the detection window relative to the anomaly. </span>
<span class="sd">        &#39;lefter&#39;  : the detection window will be on the left side of the anomaly</span>
<span class="sd">        &#39;righter&#39; : the detection window will be on the right side of the anomaly</span>
<span class="sd">        &#39;center&#39;  : the scoring window will be positioned relative to the center of anom.</span>
<span class="sd">                  </span>
<span class="sd">    clear_anomalies_mode : boolean, default=True.</span>
<span class="sd">        True : then the `left value of a Scoring function is Atp and the </span>
<span class="sd">        `right is Afp. Only the `first value inside the detection window is taken.</span>
<span class="sd">        False: then the `right value of a Scoring function is Atp and the </span>
<span class="sd">        `left is Afp. Only the `last value inside the detection window is taken.</span>

<span class="sd">    intersection_mode: {&#39;cut left widnow&#39;, &#39;cut right window&#39;, &#39;both&#39;}. </span>
<span class="sd">        Defualt=&#39;cut right window&#39;</span>
<span class="sd">        The parameter will be used if the detection windows overlap for </span>
<span class="sd">        true changepoints, which is generally undesirable and requires a </span>
<span class="sd">        different approach than simply cropping the scoring window using </span>
<span class="sd">        this parameter.</span>
<span class="sd">        &#39;cut left window&#39; : will cut the overlapping part of the left window</span>
<span class="sd">        &#39;cut right window&#39;: will cut the intersecting part of the right window</span>
<span class="sd">        &#39;both&#39;            : will crop the intersecting portion of both the left </span>
<span class="sd">        and right windows</span>
<span class="sd">    </span>
<span class="sd">    verbose:  booleant, default=True.</span>
<span class="sd">        If True, then output useful information</span>
<span class="sd">        </span>
<span class="sd">    plot_figure : booleant, default=False.</span>
<span class="sd">        If True, then drawing the score fuctions, detection windows and predictions</span>
<span class="sd">        It is used for example, for calibration the scale_koef. </span>

<span class="sd">    table_of_coef (metric=&#39;nab&#39;): pd.DataFrame of specific form. See bellow. </span>
<span class="sd">        Application profiles of NAB metric.If Defaut is None:  </span>
<span class="sd">        table_of_coef = pd.DataFrame([[1.0,-0.11,1.0,-1.0],</span>
<span class="sd">                                      [1.0,-0.22,1.0,-1.0],</span>
<span class="sd">                                      [1.0,-0.11,1.0,-2.0]])</span>
<span class="sd">        table_of_coef.index = [&#39;Standart&#39;,&#39;LowFP&#39;,&#39;LowFN&#39;]</span>
<span class="sd">        table_of_coef.index.name = &quot;Metric&quot;</span>
<span class="sd">        table_of_coef.columns = [&#39;A_tp&#39;,&#39;A_fp&#39;,&#39;A_tn&#39;,&#39;A_fn&#39;]</span>
<span class="sd">        </span>
<span class="sd">    scale_func (metric=&#39;nab&#39;): &quot;default&quot; of &quot;improved&quot;. Defualt=&quot;improved&quot;.</span>
<span class="sd">        Scoring function in NAB metric.</span>
<span class="sd">        &#39;default&#39;  : standart NAB scoring function </span>
<span class="sd">        &#39;improved&#39; : Our function for resolving disadvantages</span>
<span class="sd">        of standart NAB scoring function </span>
<span class="sd">                  </span>
<span class="sd">    scale_koef : float &gt; 0. Defualt=1.0. </span>
<span class="sd">        Smoothing factor. The smaller it is, </span>
<span class="sd">        the smoother the scoring function is.</span>
<span class="sd">                  </span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    metrics : value of metrics, depend on metric </span>
<span class="sd">        &#39;nab&#39;: tuple</span>
<span class="sd">            - Standart profile, float</span>
<span class="sd">            - Low FP profile, float</span>
<span class="sd">            - Low FN profilet</span>
<span class="sd">        &#39;average_time&#39;: tuple</span>
<span class="sd">            - Average time (average delay, or time to failure)</span>
<span class="sd">            - Missing changepoints, int</span>
<span class="sd">            - FPs, int</span>
<span class="sd">            - Number of true changepoints, int</span>
<span class="sd">        &#39;binary&#39;: tuple</span>
<span class="sd">            - F1 metric, float</span>
<span class="sd">            - False alarm rate, %, float</span>
<span class="sd">            - Missing Alarm Rate, %, float</span>
<span class="sd">        &#39;binary&#39;: tuple</span>
<span class="sd">            - TPs, int</span>
<span class="sd">            - TNs, int</span>
<span class="sd">            - FPs, int</span>
<span class="sd">            - FNS, int </span>
<span class="sd">                        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ююююююююююююююююююююююююююююююююююююююююююююююююю</span>
    <span class="c1">## проверки </span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="c1"># проверки prediction</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">true</span> <span class="o">=</span> <span class="p">[</span><span class="n">true</span><span class="p">]</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span><span class="n">prediction</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span>  <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">my_el</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="k">for</span> <span class="n">my_el</span> <span class="ow">in</span> <span class="n">prediction</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Uncorrect format for prediction&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Uncorrect format for prediction&#39;</span><span class="p">)</span>
        
    <span class="c1"># проверки длин датасетов: Number of dataset unequal</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">true</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
    
   
    
    <span class="c1"># проверки true</span>
    <span class="n">input_variant</span><span class="o">=</span> <span class="n">check_errors</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">check_sort</span><span class="p">(</span><span class="n">my_list</span><span class="p">,</span><span class="n">input_variant</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">my_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">input_variant</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">input_variant</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">input_variant</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">check_sort</span><span class="p">(</span><span class="n">true</span><span class="p">,</span><span class="n">input_variant</span><span class="p">)</span>
    <span class="n">check_sort</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># ююююююююююююююююююююююююююююююююююююююююююююююююю</span>
    <span class="c1"># part 2. To detected boundaries </span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">portion</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">numenta_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">input_variant</span><span class="o">!=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">portion</span><span class="o">=</span> <span class="mf">0.1</span>
        <span class="nb">print</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;Since you not choose numenta_time and portion, then portion will be </span><span class="si">{</span><span class="n">portion</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>      
        
    
   
    <span class="k">if</span> <span class="n">input_variant</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">detecting_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="n">single_detecting_boundaries</span><span class="p">(</span><span class="n">true_series</span> <span class="o">=</span> <span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                                            <span class="n">true_list_ts</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                                            <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                            <span class="n">numenta_time</span><span class="o">=</span><span class="n">numenta_time</span><span class="p">,</span>
                                                            <span class="n">portion</span><span class="o">=</span><span class="n">portion</span><span class="p">,</span>
                                                            <span class="n">anomaly_window_destenation</span><span class="o">=</span><span class="n">anomaly_window_destenation</span><span class="p">,</span>
                                                            <span class="n">intersection_mode</span><span class="o">=</span><span class="n">intersection_mode</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">true</span><span class="p">))]</span>
          
    <span class="k">elif</span> <span class="n">input_variant</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">detecting_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="n">single_detecting_boundaries</span><span class="p">(</span><span class="n">true_series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                                            <span class="n">true_list_ts</span><span class="o">=</span><span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                                            <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                                            <span class="n">numenta_time</span><span class="o">=</span><span class="n">numenta_time</span><span class="p">,</span>
                                                            <span class="n">portion</span><span class="o">=</span><span class="n">portion</span><span class="p">,</span>
                                                            <span class="n">anomaly_window_destenation</span><span class="o">=</span><span class="n">anomaly_window_destenation</span><span class="p">,</span>
                                                            <span class="n">intersection_mode</span><span class="o">=</span><span class="n">intersection_mode</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">true</span><span class="p">))]</span>
          
    <span class="k">elif</span> <span class="n">input_variant</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">detecting_boundaries</span> <span class="o">=</span> <span class="n">true</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># NExt anti fool system [[[t1,t2]],[]] -&gt; [[[t1,t2]],[[]]] </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detecting_boundaries</span><span class="p">)):</span> 
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">detecting_boundaries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">detecting_boundaries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">[[]]</span>   
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unknown format for true&#39;</span><span class="p">)</span>
        
        


    
    <span class="c1"># ююююююююююююююююююююююююююююююююююююююююююююююююю</span>
    <span class="c1"># part 3. To compute metric</span>
    
    <span class="c1">#print(detecting_boundaries)</span>
    <span class="k">if</span> <span class="n">plot_figure</span><span class="p">:</span>
        <span class="n">num_datasets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
        <span class="k">if</span>  <span class="p">((</span><span class="n">metric</span><span class="o">==</span><span class="s1">&#39;binary&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">metric</span><span class="o">==</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">))</span> \
            <span class="ow">and</span> <span class="p">(</span><span class="n">input_variant</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="n">num_datasets</span><span class="p">))</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">):</span>
                <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;ax&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;ax&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
                <span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;ax&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
                <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;ax&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.univariate_funcs</span> <span class="kn">import</span> <span class="n">my_scale</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="n">num_datasets</span><span class="p">))</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">detalization</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_datasets</span><span class="p">):</span>
                <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;ax&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">print_legend_boundary</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">def</span> <span class="nf">plot_cp</span><span class="p">(</span><span class="n">couple</span><span class="p">,</span><span class="n">anomaly_window_destenation</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">anomaly_window_destenation</span><span class="o">==</span><span class="s1">&#39;lefter&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">couple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">anomaly_window_destenation</span><span class="o">==</span><span class="s1">&#39;righter&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">couple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">anomaly_window_destenation</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">couple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">((</span><span class="n">couple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">couple</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">couple</span> <span class="ow">in</span> <span class="n">detecting_boundaries</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">couple</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;ax&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">couple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">couple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;detection </span><span class="se">\n</span><span class="s1">boundary&#39;</span> <span class="k">if</span> <span class="n">print_legend_boundary</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">nab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">my_scale</span><span class="p">(</span><span class="n">plot_figure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">detalization</span><span class="o">=</span><span class="n">detalization</span><span class="p">),</span>
                                        <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">couple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">couple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">periods</span><span class="o">=</span><span class="n">detalization</span><span class="p">))</span>
                        <span class="n">nab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;ax&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;brown&#39;</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;nab scoring func&#39;</span> <span class="k">if</span> <span class="n">print_legend_boundary</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">plot_cp</span><span class="p">(</span><span class="n">couple</span><span class="p">,</span><span class="n">anomaly_window_destenation</span><span class="p">,</span><span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;ax&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span>
                                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Changepoint&#39;</span> <span class="k">if</span> <span class="n">print_legend_boundary</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">print_legend_boundary</span> <span class="o">=</span> <span class="kc">False</span>                                                
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="k">pass</span> 
                <span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;ax&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
                <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;ax&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
            
            
    
    
    <span class="k">if</span>  <span class="n">metric</span><span class="o">==</span><span class="s1">&#39;nab&#39;</span><span class="p">:</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)):</span>
            <span class="n">matrix_</span> <span class="o">=</span> <span class="n">single_evaluate_nab</span><span class="p">(</span><span class="n">detecting_boundaries</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">table_of_coef</span><span class="o">=</span><span class="n">table_of_coef</span><span class="p">,</span>
                                          <span class="n">clear_anomalies_mode</span> <span class="o">=</span> <span class="n">clear_anomalies_mode</span><span class="p">,</span>
                                          <span class="n">scale_func</span> <span class="o">=</span> <span class="n">scale_func</span><span class="p">,</span>
                                          <span class="n">scale_koef</span><span class="o">=</span><span class="n">scale_koef</span><span class="p">,</span>
                                          <span class="n">plot_figure</span><span class="o">=</span><span class="n">plot_figure</span><span class="p">)</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">+</span> <span class="n">matrix_</span>      
                    
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Standart&#39;</span><span class="p">,</span> <span class="s1">&#39;LowFP&#39;</span><span class="p">,</span> <span class="s1">&#39;LowFN&#39;</span><span class="p">]</span> 
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">profile_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">desc</span><span class="p">):</span>
            <span class="n">results</span><span class="p">[</span><span class="n">profile_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">]</span><span class="o">-</span><span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">t</span><span class="p">]</span><span class="o">-</span><span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">profile_name</span><span class="p">,</span><span class="s1">&#39; - &#39;</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="n">profile_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">elif</span> <span class="n">metric</span><span class="o">==</span><span class="s1">&#39;average_time&#39;</span><span class="p">:</span>
        <span class="n">missing</span><span class="p">,</span> <span class="n">detectHistory</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">all_true_anom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)):</span>
            <span class="n">missing_</span><span class="p">,</span> <span class="n">detectHistory_</span><span class="p">,</span> <span class="n">FP_</span><span class="p">,</span> <span class="n">all_true_anom_</span> <span class="o">=</span> <span class="n">single_average_delay</span><span class="p">(</span><span class="n">detecting_boundaries</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                                                                 <span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                 <span class="n">anomaly_window_destenation</span><span class="o">=</span><span class="n">anomaly_window_destenation</span><span class="p">,</span>
                                                                                 <span class="n">clear_anomalies_mode</span><span class="o">=</span><span class="n">clear_anomalies_mode</span><span class="p">)</span>
            <span class="n">missing</span><span class="p">,</span> <span class="n">detectHistory</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">all_true_anom</span> <span class="o">=</span> <span class="n">missing</span><span class="o">+</span><span class="n">missing_</span><span class="p">,</span> <span class="n">detectHistory</span><span class="o">+</span><span class="n">detectHistory_</span><span class="p">,</span> <span class="n">FP</span><span class="o">+</span><span class="n">FP_</span><span class="p">,</span> <span class="n">all_true_anom</span><span class="o">+</span><span class="n">all_true_anom_</span>
        <span class="n">add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">detectHistory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Amount of true anomalies&#39;</span><span class="p">,</span><span class="n">all_true_anom</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A number of missed CPs = </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A number of FPs = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">FP</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average time&#39;</span><span class="p">,</span> <span class="n">add</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">add</span><span class="p">,</span> <span class="n">missing</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">FP</span><span class="p">),</span> <span class="n">all_true_anom</span>
    
    <span class="k">elif</span> <span class="p">(</span><span class="n">metric</span><span class="o">==</span><span class="s1">&#39;binary&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">metric</span><span class="o">==</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">)</span> <span class="p">:</span>
        
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">my_el</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="k">for</span> <span class="n">my_el</span> <span class="ow">in</span> <span class="n">true</span><span class="p">):</span>
            <span class="n">TP</span><span class="p">,</span><span class="n">TN</span><span class="p">,</span><span class="n">FP</span><span class="p">,</span><span class="n">FN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)):</span>
                <span class="n">TP_</span><span class="p">,</span><span class="n">TN_</span><span class="p">,</span><span class="n">FP_</span><span class="p">,</span><span class="n">FN_</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">TP</span><span class="p">,</span><span class="n">TN</span><span class="p">,</span><span class="n">FP</span><span class="p">,</span><span class="n">FN</span> <span class="o">=</span> <span class="n">TP</span><span class="o">+</span><span class="n">TP_</span><span class="p">,</span><span class="n">TN</span><span class="o">+</span><span class="n">TN_</span><span class="p">,</span><span class="n">FP</span><span class="o">+</span><span class="n">FP_</span><span class="p">,</span><span class="n">FN</span><span class="o">+</span><span class="n">FN_</span>       
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For this metric it is better if you use pd.Series format for true </span><span class="se">\n</span><span class="s1">with common index of true and prediciton&#39;</span><span class="p">)</span>
            <span class="n">TP</span><span class="p">,</span><span class="n">TN</span><span class="p">,</span><span class="n">FP</span><span class="p">,</span><span class="n">FN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)):</span>
                <span class="n">dict_cp_confusion</span> <span class="o">=</span> <span class="n">extract_cp_confusion_matrix</span><span class="p">(</span><span class="n">detecting_boundaries</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">TP</span><span class="o">+=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">dict_cp_confusion</span><span class="p">[</span><span class="s1">&#39;TPs&#39;</span><span class="p">][</span><span class="n">window</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">dict_cp_confusion</span><span class="p">[</span><span class="s1">&#39;TPs&#39;</span><span class="p">]])</span>
                <span class="n">FP</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">dict_cp_confusion</span><span class="p">[</span><span class="s1">&#39;FPs&#39;</span><span class="p">])</span>
                <span class="n">FN</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">dict_cp_confusion</span><span class="p">[</span><span class="s1">&#39;FNs&#39;</span><span class="p">])</span>
                <span class="n">TN</span><span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">TP</span> <span class="o">-</span> <span class="n">FP</span> <span class="o">-</span> <span class="n">FN</span>
            
            
        <span class="k">if</span> <span class="n">metric</span><span class="o">==</span><span class="s1">&#39;binary&#39;</span><span class="p">:</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">TP</span><span class="o">/</span><span class="p">(</span><span class="n">TP</span><span class="o">+</span><span class="p">(</span><span class="n">FN</span><span class="o">+</span><span class="n">FP</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">far</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">FP</span><span class="o">/</span><span class="p">(</span><span class="n">FP</span><span class="o">+</span><span class="n">TN</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">mar</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">FN</span><span class="o">/</span><span class="p">(</span><span class="n">FN</span><span class="o">+</span><span class="n">TP</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;False Alarm Rate </span><span class="si">{</span><span class="n">far</span><span class="si">}</span><span class="s1"> %&#39;</span> <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Missing Alarm Rate </span><span class="si">{</span><span class="n">mar</span><span class="si">}</span><span class="s1"> %&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;F1 metric </span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f1</span><span class="p">,</span><span class="n">far</span><span class="p">,</span><span class="n">mar</span>
        
        <span class="k">elif</span> <span class="n">metric</span><span class="o">==</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TP&#39;</span><span class="p">,</span><span class="n">TP</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TN&#39;</span><span class="p">,</span><span class="n">TN</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FP&#39;</span><span class="p">,</span><span class="n">FP</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FN&#39;</span><span class="p">,</span><span class="n">FN</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TP</span><span class="p">,</span><span class="n">TN</span><span class="p">,</span><span class="n">FP</span><span class="p">,</span><span class="n">FN</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Choose the perfomance metric&quot;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, V. Kozitsin.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>